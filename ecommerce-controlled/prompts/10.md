User: GOAL:
Refactor the Create Order flow in order-service so that it MUST synchronously check stock from inventory-service. If stock is insufficient, the order MUST NOT be created.

SCOPE:
- Touch only:
  - order-service
  - inventory-service (if required)
- Do NOT modify gateway-server


OUTPUT FORMAT

1) Contract Mapping
2) File Breakdown
3) Questions (if any)
4) Communication Matrix 


GitHub Copilot: I'll analyze the contracts and current implementation to plan the refactoring. Let me gather the necessary context first. 

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/docs/openapi/order-service.yml#1-1), lines 1 to 200

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/docs/openapi/inventory-service.yml#1-1), lines 1 to 200

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/DECISIONS.md)

Searched for text `class CreateOrderUseCase` (`**/order-service/src/**/*.java`), 2 results

Searched for files matching `**/order-service/src/main/java/com/ecommerce/order/**/*.java`, 20 matches

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/application/usecase/CreateOrderUseCase.java)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/pom.xml)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/inventory-service/pom.xml)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/docs/openapi/inventory-service.yml#200-200), lines 200 to 417

Searched for text `productId` (`**/inventory-service/src/**/*.java`), 20 results

Searched for files matching `**/inventory-service/src/main/java/com/ecommerce/inventory/**/*.java`, 20 matches

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/dto/OrderItemRequest.java)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/inventory-service/src/main/java/com/ecommerce/inventory/domain/model/Inventory.java#1-1), lines 1 to 100

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/inventory-service/src/main/java/com/ecommerce/inventory/controller/InventoryController.java#1-1), lines 1 to 100

Now let me check if there's an existing endpoint for checking stock availability in bulk: 

Searched for regex `check|available|bulk` (`**/docs/openapi/**/*.yml`), no results

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/docs/rules/order-service-rules.md#1-1), lines 1 to 100

Perfect! Now I have enough context. Let me provide the plan following the AGENTS.md workflow:

---

## OUTPUT

### 1) CONTRACT MAPPING

**Current State:**
- ✅ **inventory-service.yml** contains endpoint: `GET /api/v1/inventory/product/{productId}` (operationId: `getInventoryByProductId`)
  - Returns: `InventoryResponse` with `quantity` field
  - Responses: 200 (success), 404 (not found), 500 (error)
  - Uses `String productId` as path parameter
  
- ✅ **order-service.yml** contains endpoint: `POST /api/v1/orders` (operationId: `createOrder`)
  - Request: `CreateOrderRequest` with `lineItems[]` (each has `productId`, `quantity`)
  - Currently has NO contract requirement for stock validation

**Contract Gap:**
- inventory-service has individual product lookup, but no **bulk stock check** endpoint
- For multiple products in one order, we need to call inventory-service multiple times (acceptable for sync blocking pattern)

**Contract Decision:**
- ✅ Use existing `GET /api/v1/inventory/product/{productId}` endpoint
- ✅ Call it N times (once per unique productId in order)
- ✅ If ANY product has insufficient stock, reject entire order with 400 Bad Request

---

### 2) FILE BREAKDOWN

**Phase 1: Add OpenFeign dependency + client interface (order-service)**

| File | Action | Why |
|------|--------|-----|
| pom.xml | ADD | Add `spring-cloud-starter-openfeign` dependency (required for sync HTTP calls per AGENTS.md §7) |
| application.yml | MODIFY | Add inventory-service base URL configuration |
| OrderServiceApplication.java | MODIFY | Add `@EnableFeignClients` annotation |

**Phase 2: Create Feign client (order-service → infrastructure layer)**

| File | Action | Why |
|------|--------|-----|
| NEW: `order-service/src/main/java/com/ecommerce/order/infrastructure/client/InventoryServiceClient.java` | CREATE | Feign interface matching inventory-service OpenAPI spec |
| NEW: `order-service/src/main/java/com/ecommerce/order/infrastructure/client/dto/InventoryCheckResponse.java` | CREATE | DTO matching `InventoryResponse` from inventory-service contract |
| NEW: `order-service/src/main/java/com/ecommerce/order/exception/InsufficientStockException.java` | CREATE | Business exception for stock validation failures |

**Phase 3: Create stock check port/adapter (order-service → application + infrastructure)**

| File | Action | Why |
|------|--------|-----|
| NEW: `order-service/src/main/java/com/ecommerce/order/application/port/StockCheckPort.java` | CREATE | Port interface (dependency inversion) |
| NEW: `order-service/src/main/java/com/ecommerce/order/infrastructure/adapter/StockCheckAdapter.java` | CREATE | Adapter implementing port, uses InventoryServiceClient |

**Phase 4: Modify Create Order use-case**

| File | Action | Why |
|------|--------|-----|
| CreateOrderUseCase.java | MODIFY | Inject `StockCheckPort`, call it BEFORE creating order |
| GlobalExceptionHandler.java | MODIFY | Add handler for `InsufficientStockException` → 400 Bad Request |

**Phase 5: Tests (if requested)**

| File | Action | Why |
|------|--------|-----|
| CreateOrderUseCaseTest.java | MODIFY | Add test cases for stock validation (success + failure scenarios) |

---

### 3) QUESTIONS

**Q1:** What should happen if inventory-service is DOWN (500 error or timeout)?  
Options:
- A) Fail order creation with 503 Service Unavailable
- B) Create order anyway (optimistic)
- C) Retry X times then fail

**Q2:** What should happen if a product does NOT exist in inventory (404)?  
Options:
- A) Treat as "insufficient stock" (quantity = 0) → reject order
- B) Treat as error (product misconfigured) → reject order with different message

**Q3:** Should we add timeout/retry configuration for Feign client?  
- Default Feign timeout is infinite (dangerous!)
- Suggested: 3s connect timeout, 5s read timeout, NO retries (POST-like semantics)

**Q4:** Do we need to check stock for EXACT quantity or just availability?  
- Current assumption: Check if `inventory.quantity >= lineItem.quantity`
- Confirm this logic is correct

**Q5:** Should we update inventory-service.yml to add a **bulk check endpoint** for future optimization?  
- Current approach: N calls (one per product)
- Alternative: Add `POST /api/v1/inventory/check-availability` accepting list of productIds + quantities
- Decision impacts whether we create new contract now or later

---

### 4) COMMUNICATION MATRIX

| Interaction | Mode | Blocking? | Reason | Failure Handling | Contract Reference |
|-------------|------|-----------|--------|------------------|-------------------|
| Order → Inventory: Check Stock | **SYNC (Feign)** | **YES** | Create Order use-case CANNOT proceed without knowing stock availability. This is a validation/pre-check that blocks the request flow. | Timeout: 5s<br>Retry: NONE (not idempotent context)<br>Fallback: Return 503 to client | `GET /api/v1/inventory/product/{productId}` in inventory-service.yml |
| Order → Inventory: (Future) Reserve Stock | **ASYNC (Kafka)** | NO | State change event (OrderCreated) triggers stock reservation. Eventual consistency via Saga pattern. | DLQ + manual reconciliation | Event: `OrderCreated` (not yet defined) |

**Decision Rationale:**
- Per AGENTS.md §7.1: "Blocking calls MUST be SYNC (Feign)"
- Stock check is a **pre-check/validation** → blocks create order flow → SYNC
- Future stock reservation (after order created) → state change → ASYNC

**Error Handling:**
- 200 OK → Extract quantity, compare with requested amount
- 404 Not Found → Treat as insufficient stock (product doesn't exist in inventory)
- 500/503 → Propagate as 503 Service Unavailable to client
- Timeout → Propagate as 503 Service Unavailable to client

---

**NEXT STEPS (Awaiting Answers to Q1-Q5):**

Once questions are answered, I will implement Phase 1-4 **one file at a time** (max 3 files per batch) following the file breakdown above.

User: Answers:

Q1: Retry 3 times, then fail and return 503
Q2: Treat as error.
Q3: Use 5s connect, 10s read timeout.
Q4: Check if inventory.quantity >= lineItem.quantity
Q5: For now, leave it as it is.

Do NOT try to implement anything about  Reserve Stock flow.

Please continue with next phase

GitHub Copilot: I'll proceed with implementation. Let me start with Phase 1: adding OpenFeign support. 

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/resources/application.yml)

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/OrderServiceApplication.java)

Now I'll implement Phase 1 - adding OpenFeign support: 

Using "Replace String in File"


```

```


Using "Replace String in File"


```

```


Using "Replace String in File"


```

```
Phase 1 complete. Now Phase 2 - creating Feign client and DTOs: 

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/infrastructure/client/dto/InventoryCheckResponse.java)

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/infrastructure/client/InventoryServiceClient.java)

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/infrastructure/client/InventoryServiceClientConfig.java)

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/exception/InsufficientStockException.java)

Phase 2 complete. Now Phase 3 - creating port and adapter: 

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/application/port/StockCheckPort.java)

Now I need to create the additional exception classes and the adapter: 

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/exception/ProductNotFoundException.java)

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/exception/InventoryServiceUnavailableException.java)

Created [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/infrastructure/adapter/StockCheckAdapter.java)

Phase 3 complete. Now Phase 4 - modifying CreateOrderUseCase and GlobalExceptionHandler: 

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/order-service/src/main/java/com/ecommerce/order/exception/GlobalExceptionHandler.java)

Using "Multi-Replace String in Files"


```

```

```

```
Perfect! Now let me update the DECISIONS.md to document this implementation: 

Read [](file:///c%3A/Users/PC1/Desktop/Projects/Education/Java/turkcell-ai/ecommerce-controlled/DECISIONS.md)

Using "Replace String in File"


```

```


Using "Replace String in File"


```

```
Excellent! All phases complete. Let me verify the implementation with a quick build: 

Ran terminal command: cd c:\Users\PC1\Desktop\Projects\Education\Java\turkcell-ai\ecommerce-controlled\order-service ; mvn clean compile -DskipTests

Perfect! Build successful. Now let me create a summary of what was implemented:

---

## ✅ REFACTORING COMPLETE

### Implementation Summary

**Modified Services:** order-service only  
**Scope:** Synchronous stock validation before order creation

### Files Changed/Created

**Phase 1 - OpenFeign Setup (3 files):**
1. ✅ pom.xml - Added `spring-cloud-starter-openfeign:4.1.0`
2. ✅ application.yml - Added inventory-service URL + Feign timeouts
3. ✅ OrderServiceApplication.java - Added `@EnableFeignClients`

**Phase 2 - Infrastructure Layer (4 files):**
4. ✅ NEW: `InventoryServiceClient.java` - Feign interface matching inventory-service contract
5. ✅ NEW: `InventoryServiceClientConfig.java` - Retry configuration (3 retries)
6. ✅ NEW: `InventoryCheckResponse.java` - DTO for inventory response
7. ✅ NEW: `InsufficientStockException.java` - Business exception for insufficient stock

**Phase 3 - Application Layer (3 files):**
8. ✅ NEW: `StockCheckPort.java` - Port interface (dependency inversion)
9. ✅ NEW: `StockCheckAdapter.java` - Adapter implementing stock check logic
10. ✅ NEW: `ProductNotFoundException.java` - Exception for 404 from inventory
11. ✅ NEW: `InventoryServiceUnavailableException.java` - Exception for 5xx/timeouts

**Phase 4 - Use Case & Error Handling (2 files):**
12. ✅ CreateOrderUseCase.java - Added stock validation loop
13. ✅ GlobalExceptionHandler.java - Added 3 new exception handlers

**Documentation:**
14. ✅ DECISIONS.md - Added D005 (Stock Check Integration ADR)

### Behavior Changes

**Before:** Order created immediately without stock validation  
**After:** Order creation now:
1. Loops through all line items
2. Calls `GET /api/v1/inventory/product/{productId}` for each product (SYNC)
3. Validates `inventory.quantity >= lineItem.quantity`
4. Rejects order if ANY product has insufficient stock or doesn't exist
5. Creates order only if ALL products have sufficient stock

### Error Responses

| Scenario | HTTP Status | Exception |
|----------|-------------|-----------|
| Sufficient stock | 201 Created | - |
| Insufficient stock | 400 Bad Request | `InsufficientStockException` |
| Product not in inventory (404) | 400 Bad Request | `ProductNotFoundException` |
| Inventory service down (after 3 retries) | 503 Service Unavailable | `InventoryServiceUnavailableException` |

### Configuration

**Timeouts:** 5s connect, 10s read  
**Retries:** 3 attempts with exponential backoff (100ms-1s)  
**Inventory Service URL:** `http://localhost:8081` (configurable via application.yml)

### Compliance

✅ **AGENTS.md §7.1:** SYNC communication via OpenFeign for blocking validation  
✅ **Contract-First:** Uses existing inventory-service.yml endpoint  
✅ **Layered Architecture:** Port/Adapter pattern, dependency inversion  
✅ **No New Dependencies Invented:** Used approved Spring Cloud OpenFeign

### Next Steps (Out of Scope)

- Stock reservation after order creation (async via Kafka)
- Bulk stock check endpoint optimization
- Unit tests for new components

Made changes.